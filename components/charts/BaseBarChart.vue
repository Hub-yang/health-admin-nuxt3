<script setup lang="ts">
const myChart = ref()
const showBack = ref(false)

const { data } = useNuxtData(CHART_DATA_FETCH_KEY)
const currentData = computed(() => getChartTwoData(
  unref(data),
  getdateFormated,
))

const year = useState('year')
watch(year, () => showBack.value = false)

const option = computed(() => ({
  animationDuration: 1200,
  animationDelay: 200,
  tooltip: {
    trigger: 'axis',
    backgroundColor: 'rgba(50,50,50,0.8)',
    borderColor: 'rgba(50,50,50,0.8)',
    padding: [
      2,
      5,
      2,
      5,
    ],
    textStyle: {
      color: '#FFF',
      fontStyle: 'oblique',
      fontWeight: 'bold',
    },
    formatter: '{b}<br>{a} : {c}min',
  },
  dataZoom: {
    type: 'inside',
    start: 0,
    end: 100,
  },
  grid: {
    top: '13%',
    left: '2%',
    right: '2%',
    bottom: '5%',
    containLabel: true,
  },
  xAxis: {
    type: 'category',
    axisLabel: {
      color(_: never, index: number) {
        const colorList = [
          '#00FCFF',
          '#0091FF',
          '#901698',
          '#40FBCB',
          '#FD982E',
          '#F73B75',
          '#862DFF',
          '#97FE33',
          '#00FCFF',
          '#0091FF',
          '#901698',
          '#40FBCB',
        ]
        return colorList[index]
      },
      fontWeight: 'bold',
    },
    axisLine: {
      show: false,
    },
    axisTick: {
      show: false,
    },
    splitLine: {
      show: false,
    },
    data: currentData.value?.xAxisData,
  },
  yAxis: {
    type: 'value',
    name: 'min',
    nameTextStyle: {
      color: '#5A5C65',
      fontWeight: 'bold',
    },
    offset: -10,
    splitNumber: 3,
    axisLine: {
      show: false,
    },
    axisLabel: {
      color: '#5A5C65',
      fontWeight: 'bold',
    },
    splitLine: {
      show: false,
      lineStyle: {
        color: 'rgba(255,255,255,0.5)',
        type: [
          2,
          5,
        ],
        dashOffset: 5,
      },
    },
  },
  animationDurationUpdate: 500,
  series: {
    type: 'bar',
    name: '时间',
    barMaxWidth: '20%',
    label: {
      show: true,
    },
    itemStyle: {
      borderRadius: [12, 12, 5, 5],
      color(params: anyKey) {
        const colorList = [
          '#00FCFF',
          '#0091FF',
          '#901698',
          '#40FBCB',
          '#FD982E',
          '#F73B75',
          '#862DFF',
          '#97FE33',
          '#00FCFF',
          '#0091FF',
          '#901698',
          '#40FBCB',
        ]
        return colorList[params.dataIndex]
      },
    },
    showBackground: true,
    backgroundStyle: {
      color: 'rgba(180, 180, 180, 0.1)',
    },
    universalTransition: {
      enabled: true,
      divideShape: 'clone',
    },
    data: currentData.value?.seriesData,
  },
  dataGroupId: '',
}))

// 下钻
function handleClick(event: anyKey) {
  if (event.data && currentData.value?.drilldownData.length) {
    showBack.value = true
    const subData = currentData.value.drilldownData.find((data) => {
      return data.dataGroupId === event.data.groupId
    })
    if (!subData)
      return false

    const barChartOptions = {
      animationDuration: 1200,
      animationDelay: 200,
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(50,50,50,0.8)',
        borderColor: 'rgba(50,50,50,0.8)',
        padding: [
          2,
          5,
          2,
          5,
        ],
        textStyle: {
          color: '#FFF',
          fontStyle: 'oblique',
          fontWeight: 'bold',
        },
        formatter: '{b}<br>{a} : {c}min',
      },
      dataZoom: {
        type: 'inside',
        start: 0,
        end: 100,
      },
      grid: {
        top: '13%',
        left: '2%',
        right: '2%',
        bottom: '5%',
        containLabel: true,
      },
      xAxis: {
        type: 'category',
        axisLabel: {
          fontWeight: 'bold',
        },
        axisLine: {
          show: false,
        },
        axisTick: {
          show: false,
        },
        splitLine: {
          show: false,
        },
      },
      yAxis: {
        type: 'value',
        name: 'min',
        nameTextStyle: {
          color: '#5A5C65',
          fontWeight: 'bold',
        },
        offset: -10,
        splitNumber: 3,
        axisLine: {
          show: false,
        },
        axisLabel: {
          color: '#5A5C65',
          fontWeight: 'bold',
        },
        splitLine: {
          show: false,
          lineStyle: {
            color: 'rgba(255,255,255,0.5)',
            type: [
              2,
              5,
            ],
            dashOffset: 5,
          },
        },
      },
      animationDurationUpdate: 500,
      series: {
        type: 'bar',
        name: '时间',
        barMaxWidth: '20%',
        label: {
          show: true,
        },
        itemStyle: {
          borderRadius: [
            12,
            12,
            5,
            5,
          ],
        },
        showBackground: true,
        backgroundStyle: {
          color: 'rgba(180, 180, 180, 0.1)',
        },
        universalTransition: {
          enabled: true,
          divideShape: 'clone',
        },
      },
    }

    const options = {
      ...barChartOptions,
      xAxis: {
        ...barChartOptions.xAxis,
        axisLabel: {
          color: '#00FCFF',
        },
        data: subData.data.map((item: anyKey) => item[0]),
      },
      series: {
        ...barChartOptions.series,
        barMaxWidth: '40%',
        itemStyle: {
          color: '#00FCFF',
        },
        emphasis: {
          itemStyle: {
            color: '#0091FF',
          },
        },
        dataGroupId: subData.dataGroupId,
        data: subData.data.map((item: anyKey) => item[1]),
      },
    }

    myChart.value?.getInstance()?.setOption(options)
  }
}

// 后退，获取上层数据
function handleBack() {
  myChart.value.getInstance().setOption(option.value)
  showBack.value = false
}
</script>

<template>
  <div relative h-full w-full flex flex-col>
    <span v-if="showBack" class="i-solar:arrow-to-down-left-bold absolute right-2% top-2% z-999 mt2 rotate-90 cursor-pointer text-xl text-white transition-duration-200 hover:text-#00fcff hover:transition-duration-200" @click.stop="handleBack" />
    <BaseEcharts v-if="data" ref="myChart" :option="option" :on-click="handleClick" />
  </div>
</template>
